services:
  setup:
    image: python:3.11-slim
    container_name: insights_setup
    restart: "no"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - frappe_docker_data:/opt/frappe_docker
      - frappe_sites_data:/opt/frappe_docker/sites
      - frappe_logs_data:/opt/frappe_docker/logs
    environment:
      PROJECT_NAME: insights_prod_setup
      ADMIN_EMAIL: lgotcfg@gmail.com
      SITE_DOMAIN: bi.growatt.app
    command: >
      bash -c "
      set -e &&
      apt-get update -qq &&
      apt-get install -y git wget curl unzip docker.io &&
      if [ ! -d /opt/frappe_docker/.git ]; then
        git clone --depth=1 https://github.com/frappe/frappe_docker.git /opt/frappe_docker;
      fi &&
      cd /opt/frappe_docker &&
      wget -q https://frappe.io/easy-install.py -O easy-install.py &&
      python3 easy-install.py deploy \
        --project=${PROJECT_NAME} \
        --email=${ADMIN_EMAIL} \
        --image=ghcr.io/frappe/insights \
        --version=stable \
        --app=insights \
        --sitename=${SITE_DOMAIN} &&
      docker compose -p ${PROJECT_NAME} exec backend bench set-config -g server_script_enabled 1
      "

volumes:
  frappe_docker_data:
  frappe_sites_data:
  frappe_logs_data: